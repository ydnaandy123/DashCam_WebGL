<!DOCTYPE html>
<html lang="en">
	<head>
		<title>correlation_3dDepth_point_multi</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	</head>

	<body>		
		<script src="../src/VideoSource/pathPoint.js"></script>
		
		<script src="../libs/mrdoob-three.js-5c6ec4a/examples/../build/three.min.js"></script>
		
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
		

		<script src="../libs/GSVPanoDepth.js-master/examples/js/jquery.min.js" type="text/javascript"></script>
		<script src="../libs/GSVPanoDepth.js-master/examples/js/jquery.base64.min.js" type="text/javascript"></script>
		<script src="../libs/GSVPanoDepth.js-master/examples/js/zpipe.min.js" type="text/javascript"></script>		
		<script src="../libs/GSVPanoDepth.js-master/examples/js/GSVPano.js" type="text/javascript"></script>
		<script src="../libs/GSVPanoDepth.js-master/src/GSVPanoDepth.js" type="text/javascript"></script>		

		<script>

			var svs = new google.maps.StreetViewService();
			
			init();

			function init() {	
				for(var i=0;i<=pathPoint.length/pathPoint.length;i++){
					render_street_point_cloud(pathPoint[2*i], pathPoint[2*i+1],i);	
				}
			}			
			
			function render_street_point_cloud(lat, lon, index){
				var img_canvas_context = 0;
				var main_rotation = 0;
				var pano_loader = new GSVPANO.PanoLoader({
					zoom: 1
				});
				var depth_loader = new GSVPANO.PanoDepthLoader();	

				depth_loader.onDepthLoad = function () {
					var x, y, canvas, context, image, w, h, c;
					
					canvas = document.createElement("canvas");
					context = canvas.getContext('2d');

					w = this.depthMap.width;
					h = this.depthMap.height;

					canvas.setAttribute('width', w);
					canvas.setAttribute('height', h);
					
					image = context.getImageData(0, 0, w, h);

					for(y=0; y<h; ++y) {
						for(x=0; x<w; ++x) {
							c = this.depthMap.depthMap[y*w + x] / 50 * 255;
							image.data[4*(y*w + x)    ] = c;
							image.data[4*(y*w + x) + 1] = c;
							image.data[4*(y*w + x) + 2] = c;
							image.data[4*(y*w + x) + 3] = 255;
						}
					}

					context.putImageData(image, 0, 0);

					gDepthMap = this.depthMap;

					document.body.appendChild(canvas);
					var a = $("<a>").attr("href", canvas.toDataURL('image/png')).attr("download", index+"d.png").appendTo("body");
					a[0].click();
					a.remove();	
				}				
				
				pano_loader.onPanoramaLoad = function() {
					document.body.appendChild(this.canvas);
					depth_loader.load(this.panoId);
					var a = $("<a>").attr("href", this.canvas.toDataURL('image/png')).attr("download", index+".png").appendTo("body");
					a[0].click();
					a.remove();	
				};
				//load pano
				pano_loader.load(new google.maps.LatLng(lat,lon))
			}
		</script>
	</body>
</html>
