<!DOCTYPE html>
<html lang="en">
	<head>
		<title>master_streetView3D_compare</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" type="text/css" href="mystyle.css">		
	</head>

	<body>
		<div id="container" style="position:absolute; top:0px"></div>
		<div id="pano_container" class="hide"></div>
		<div id="depth_ori_container" class="hide"></div>
		<div id="depth_container" class="hide"></div>		
		
		<script src="../libs/mrdoob-three.js-5c6ec4a/examples/../build/three.min.js"></script>

		<script src="../libs/mrdoob-three.js-5c6ec4a/examples/js/controls/OrbitControls.js"></script>
		<script src="../libs/mrdoob-three.js-5c6ec4a/examples/js/Detector.js"></script>
		<script src="../libs/mrdoob-three.js-5c6ec4a/examples/js/libs/stats.min.js"></script>
		
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&key=AIzaSyCzUwlLqW8OOOpZRZtjkJGjgQQ-BV2YHHQ"></script>
		
		<script type="text/javascript" src="../libs/dat.gui.min.js"></script>		

		<script src="../libs/GSVPanoDepth.js-master/examples/js/jquery.min.js" type="text/javascript"></script>
		<script src="../libs/GSVPanoDepth.js-master/examples/js/jquery.base64.min.js" type="text/javascript"></script>
		<script src="../libs/GSVPanoDepth.js-master/examples/js/zpipe.min.js" type="text/javascript"></script>

		<script src="js/GSVPano_my.js" type="text/javascript"></script>
		<script src="js/GSVPanoDepth_my.js" type="text/javascript"></script>			
		
		<script src="../src/VideoSource/pathPoint.js"></script>
		
		<script>

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();			
			var pathPoint = [
				65.00721524416514, 25.46649485589046, 65.00717615974862, 25.466637820301457, 65.00713218978004, 25.466798655263688, 65.00708333425939, 25.466977360777378, 65.00703447873876, 25.46715606629118, 65.00698562321813, 25.46733477180487, 65.00693676769748, 25.467513477318562, 65.00688302662476, 25.4677100533836, 65.0068244, 25.46792449999998, 65.00679317129834, 25.46803304001662, 65.0067628, 25.468138599999975, 65.00669933608518, 25.468368559287455, 65.0066895, 25.46840420000001, 65.00663565916852, 25.468604969818216, 65.00657531896323, 25.468829987272898, 65.00652781818214, 25.469007117856336, 65.00647586888827, 25.46920083534326, 65.00641929070427, 25.469411811912778, 65.0063619256013, 25.469625720809745, 65.00631091651434, 25.469815927010814, 65.00625493849799, 25.470024658514035, 65.0062453, 25.47006060000001, 65.00623376650798, 25.470255105675278, 65.00630276615095, 25.470355243444487, 65.00721524416514, 25.46649485589046, 65.00717615974862, 25.466637820301457, 65.00713218978004, 25.466798655263688, 65.00708333425939, 25.466977360777378, 65.00703447873876, 25.46715606629118, 65.00698562321813, 25.46733477180487, 65.00693676769748, 25.467513477318562, 65.00688302662476, 25.4677100533836, 65.0068244, 25.46792449999998, 65.00679317129834, 25.46803304001662, 65.0067628, 25.468138599999975, 65.00669933608518, 25.468368559287455, 65.0066895, 25.46840420000001, 65.00663565916852, 25.468604969818216, 65.00657531896323, 25.468829987272898, 65.00652781818214, 25.469007117856336, 65.00647586888827, 25.46920083534326, 65.00641929070427, 25.469411811912778, 65.0063619256013, 25.469625720809745, 65.00631091651434, 25.469815927010814, 65.00625493849799, 25.470024658514035, 65.0062453, 25.47006060000001, 65.00623376650798, 25.470255105675278, 65.00630276615095, 25.470355243444487			
			];
			//THREE.js
			var stats;
			var camera, controls, scene, renderer;
			//GOOGLE
			var svs = new google.maps.StreetViewService();
			//DAT
			var show_pano = false, show_depth = false, method = 'cavallo';
			//POINT CLOUD
			var point_cloud_material, point_size = 0.1;			
			var root_street_view_set = new THREE.Object3D();			
			//----- POINT CLOUD COMPOSE -----	
			var Mine = [], Cavallo = [], dir_mine, dir_cavallo = new THREE.Vector3(0,100,0);
			//Marco Cavallo's
			var x0=0, z0=0, earthRatio = 20037508.34;				
			//Mine
			var wX0, wY0, wZ0, earthR = 6371000;	
			//DEMO
			
			init();
			animate();			
						
			function init() {		
			
				DAT_view();
				THREE_scene_init();	
				
				//----- EVENT LISTENER -----
				window.addEventListener( 'resize', onWindowResize, false );
				document.addEventListener('mousedown', on_document_mouse_down, false);				
				//----- DEMO -----	
				pathPoint = pathPoint.slice(0,20);
				for(var i=0;i<pathPoint.length/2;i++){
					render_street_point_cloud(pathPoint[2*i], pathPoint[2*i+1],i);	
				}
			}					
			function render_street_point_cloud(lat, lon, index){
				console.log(index, lat, lon);
				//----- EACH SINGLE STREETVIEW -----
				var img_canvas_context = 0;
				var main_rotation = 0;
				var pano_loader = new GSVPANO.PanoLoader({
					zoom: 1
				});
				var depth_loader = new GSVPANO.PanoDepthLoader();	
				var root_street_view = new THREE.Object3D();	
				//World Axis to THREE.js Axis
				var wX, wY, wZ, wR, wT;
				wR = earthR*Math.cos(lat * Math.PI / 180.0);
				wY = earthR*Math.sin(lat * Math.PI / 180.0);
				wX = wR*Math.sin(lon * Math.PI / 180.0);
				wZ = wR*Math.cos(lon * Math.PI / 180.0);				
				wT = new THREE.Vector3(wX, wY, wZ);
				if(index==0){
					wX0 = wX; wY0 = wY; wZ0 = wZ;
					wX = 0; wY = 0; wZ = 0;
				}
				else{
					wX = wX - wX0; wY = wY - wY0; wZ = wZ - wZ0;
				}				
				//Marco Cavallo's Projection
				var xoffs = lon * earthRatio /180 - x0;
				var zoffs = Math.log(Math.tan((90+lat) * Math.PI / 360)) / (Math.PI/180) * (earthRatio/180) - z0;
				if(index==0){
					x0 = xoffs; z0=zoffs;
					xoffs = 0; zoffs = 0;
				}				
				//----- LOAD PANO -----
				pano_loader.load(new google.maps.LatLng(lat,lon));
				pano_loader.onPanoramaLoad = function () {
					// Get Panoramic
					var pano_container = document.getElementById('pano_container');
					pano_container.appendChild(this.canvas);	
					// Get Other Links
					var root_helper_object = new THREE.Object3D();
					createLinks(root_helper_object, this.data, index);
					root_street_view.add(root_helper_object);
					// Store PANO and HEADING, then call depth_loader
					img_canvas_context = this.canvas.getContext('2d');
					main_rotation = this.data.tiles.centerHeading;
					depth_loader.load(this.panoId);
				};
				
				//----- LOAD DEPTH -----
				depth_loader.onDepthLoad = function () {			
					// Depth Map					
					drawDepthMap(this.depthMap);
					// Create Point Cloud
					var geometry = new THREE.BufferGeometry();			
					createPointCloud(geometry, this.depthMap, img_canvas_context);	
					var pointcloud = new THREE.Points(geometry, point_cloud_material);
					pointcloud.rotation.y = -main_rotation * Math.PI / 180.0;
					root_street_view.add(pointcloud);	
					root_street_view.name = index;
					root_street_view_set.add(root_street_view)
					

					var matrix = new THREE.Object3D();
					matrix.position.x = xoffs;
					matrix.position.z = -zoffs;	
					matrix.updateMatrix();
					Cavallo[index] = matrix.matrix;					
					var matrix = new THREE.Object3D();
					matrix.lookAt(wT);
					matrix.rotateOnAxis(new THREE.Vector3(1,0,0), Math.PI/2);
					matrix.position.x = wX;
					matrix.position.y = wY;
					matrix.position.z = wZ;
					matrix.updateMatrix();
					Mine[index] = matrix.matrix;
					

					if(index==0){
						dir_mine = wT.clone().normalize().multiplyScalar(100);
					}	
					else{
						//Mine[index].multiply(new THREE.Matrix4().getInverse(Mine[0]))
					}
					//----- Marco Cavallo's Way -----
					if(method == 'cavallo'){
						root_street_view.applyMatrix(Cavallo[index])
					}
					//----- My Way -----
					else if(method == 'mine'){
						root_street_view.applyMatrix(Mine[index])				
						camera.position.set(dir_mine.x, dir_mine.y, dir_mine.z);
						camera.lookAt(0.0, 0.0, 0.0);
					}
					
				}
				root_street_view_set.add(root_street_view);				
			}			
			function createLinks(root_helper_object, data, index){
				if (data.links.length > 0) {
					for (var i = 0; i < data.links.length; ++i) {
						// Draw arrow
						var helper_geometry_base = new THREE.Object3D();
						var helper_shape = new THREE.Shape();
						helper_shape.moveTo(0, 0);
						helper_shape.lineTo(-0.6, 1.25);
						helper_shape.lineTo(0.6, 1.25);
						helper_shape.lineTo(0, 0);
						var extrudeSettings = {
							amount: 0.25
						};
						extrudeSettings.bevelEnabled = false;
						var helper_geometry = new THREE.ExtrudeGeometry(helper_shape, extrudeSettings);
						var helper_mesh = new THREE.Mesh(helper_geometry, new THREE.MeshNormalMaterial())
						// Rotate heading && Place it
						helper_mesh.userData = data.links[i].pano;
						helper_mesh.rotation.x = Math.PI / 2.0;
						helper_mesh.position.z = -5;
						helper_geometry_base.rotation.y = -data.links[i].heading * Math.PI / 180;
						helper_geometry_base.add(helper_mesh);
	
						root_helper_object.add(helper_geometry_base);
					}
				}				
			}				
			function DAT_view(){
				//----- DAT GUI -----
				gui = new dat.GUI();
				f_baisc = gui.addFolder('Basic');
				f_baisc.open();
				f_download = gui.addFolder('download');
				f_download.open();
				
				f_baisc.add(this, "point_size", 0.1, 2.0).name("Point size").onChange(function (value) {
					point_cloud_material.size = point_size;
				});	
				f_baisc.add(this, "show_pano", false).name("Show pano image").onChange(function (value) {
					if (value)
						document.getElementById("pano_container").className = "show";
					else
						document.getElementById("pano_container").className = "hide";
				});
				f_baisc.add(this, "show_depth", false).name("Show depth").onChange(function (value) {
					if (value)
						document.getElementById("depth_container").className = "show";
					else
						document.getElementById("depth_container").className = "hide";
				});			
				f_baisc.add(this, "method",{Mine: 'mine', Cavallo: 'cavallo'}).onChange(function (value){
					if(value == 'mine'){	
						for(var i=0; i<root_street_view_set.children.length; i++){
							root_street_view_set.children[i].applyMatrix(new THREE.Matrix4().getInverse(Cavallo[root_street_view_set.children[i].name]));
							root_street_view_set.children[i].applyMatrix(Mine[root_street_view_set.children[i].name])			
						}
						camera.position.set(dir_mine.x, dir_mine.y, dir_mine.z);
						console.log(camera.position, dir_mine);
						camera.lookAt(0.0, 0.0, 0.0);						
					}
					else if(value == 'cavallo'){				
						for(var i=0; i<root_street_view_set.children.length; i++){
							root_street_view_set.children[i].applyMatrix(new THREE.Matrix4().getInverse(Mine[root_street_view_set.children[i].name]));
							root_street_view_set.children[i].applyMatrix(Cavallo[root_street_view_set.children[i].name])	
						}	
						camera.position.set(dir_cavallo.x, dir_cavallo.y, dir_cavallo.z);
						console.log(camera.position, dir_cavallo);
						camera.lookAt(0.0, 0.0, 0.0);						
					}
				});
			}
			function THREE_scene_init(){
				//----- THREE.JS OBJECT -----
				// Scene Create
				scene = new THREE.Scene();
				// Render
				renderer = new THREE.WebGLRenderer({
					antialias: true
				});				
				renderer.setClearColor( 0xffffff );
				renderer.setSize(window.innerWidth, window.innerHeight);
				// Container Created
				var container = document.getElementById( 'container' );
				container.appendChild( renderer.domElement );	
				// Camera Setting				
				camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 10000);
				camera.position.set(0, 50, 0);
				camera.lookAt(0.0, 0.0, 0.0);
				camera.up.set(0.0, 1.0, 0.0)
				// Lights	
				light = new THREE.AmbientLight( 0xffffff );
				scene.add( light );
				// Controls && Project
				controls = new THREE.OrbitControls(camera, renderer.domElement);
				raycaster = new THREE.Raycaster();
				// State Monitor
				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				stats.domElement.style.zIndex = 100;
				container.appendChild( stats.domElement );			
				// point cloud material
				point_cloud_material = new THREE.PointsMaterial({
					size: point_size,
					vertexColors: true,
					sizeAttenuation: true,
					fog: true
				});					
				// Point Cloud Objects
				scene.add(root_street_view_set);
				// world (x-z plane)
				var gridXZ = new THREE.GridHelper(1000, 50, new THREE.Color(0xff0000), new THREE.Color(0xffffff));				
				//scene.add(gridXZ);			
			}				
			function drawDepthMap(depthMap){
				var canvas = document.createElement("canvas");
				var context = canvas.getContext('2d');
				canvas.setAttribute('width', depthMap.width);
				canvas.setAttribute('height', depthMap.height);
				var image = context.getImageData(0, 0, depthMap.width, depthMap.height);
				for (var y = 0; y < depthMap.height; ++y) {
					for (var x = 0; x < depthMap.width; ++x) {
						var col = depthMap.depthMap[y * depthMap.width + x] / 50 * 255;
						image.data[4 * (y * depthMap.width + x) + 0] = col;
						image.data[4 * (y * depthMap.width + x) + 1] = col;
						image.data[4 * (y * depthMap.width + x) + 2] = col;
						image.data[4 * (y * depthMap.width + x) + 3] = 255;
					}
				}					
				context.putImageData(image, 0, 0);
				vdpeth_container = document.getElementById('depth_container');
				depth_container.appendChild(canvas);				
			}			
			function createPointCloud(geometry, depthMap, img_canvas_context){
				var color_data = img_canvas_context.getImageData(0, 0, img_canvas_context.canvas.width, img_canvas_context.canvas.height).data;									
				var geometryTexture = new THREE.BufferGeometry();
				var num_points = depthMap.width * depthMap.height;
				var positions = new Float32Array(num_points * 3);
				var colors = new Float32Array(num_points * 3);					
				var n = 0;						
				for (var y = 0; y < depthMap.height; ++y) {
					var lat = -(y / depthMap.height) * 180.0 + 90.0;
					var r = Math.cos(lat * Math.PI / 180.0);
					for (var x = 0; x < depthMap.width; ++x) {	
						var depth = parseFloat(depthMap.depthMap[y * depthMap.width + x]);
						//if(depth>maxDepth)continue;
						// Panoromic to Spherical							
						var lng = (x / depthMap.width) * 360.0 - 180.0;
						// Spherical Axis to THREE.js Axis
						var pos = new THREE.Vector3();
						pos.y = Math.sin(lat * Math.PI / 180.0);
						pos.x = (r * Math.sin(lng * Math.PI / 180.0));
						pos.z = -(r * Math.cos(lng * Math.PI / 180.0)); // IMPORTANT!!!!
						// Multiple by Depth
						pos.multiplyScalar(depth);
						// Store Position and Color of Each Point
						positions[3 * n + 0] = isNaN(pos.x) ? 0 : pos.x;
						positions[3 * n + 1] = isNaN(pos.y) ? 0 : pos.y;
						positions[3 * n + 2] = isNaN(pos.z) ? 0 : pos.z;
						var color_canvas_x = parseInt((x / depthMap.width) * img_canvas_context.canvas.width);
						var color_canvas_y = parseInt((y / depthMap.height) * img_canvas_context.canvas.height);
						var color_index = color_canvas_y * img_canvas_context.canvas.width * 4 + color_canvas_x * 4;							
						colors[3 * n + 0] = (color_data[color_index + 0]) / 255.0;
						colors[3 * n + 1] = (color_data[color_index + 1]) / 255.0;
						colors[3 * n + 2] = (color_data[color_index + 2]) / 255.0;											
						n++;
					}
				}						
				// Point Cloud geometry
				geometry.addAttribute('position', new THREE.BufferAttribute(positions, 3));
				geometry.addAttribute('color', new THREE.BufferAttribute(colors, 3));
				geometry.computeBoundingBox();		
			}		
			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}
			function animate() {
				requestAnimationFrame( animate );
				controls.update(); // required if controls.enableDamping = true, or if controls.autoRotate = true
				stats.update();				
				render();
			}
			function render() {
				renderer.render( scene, camera );
			}			
			function on_document_mouse_down(event) {			
			}				
		</script>
	</body>
</html>
